---
title: "Workbook Task 3: Assignment for Quantitative Methods"
author: "Candidate number: 1058243"
date: "Submission date: 09 January 2022"
subtitle: "Word count: 2,500"
output:
  pdf_document: default
  html_document: default
fontsize: 12pt
linestretch: 1.2
header-includes:
  \usepackage{float}
  \floatplacement{figure}{H}
  \floatplacement{table}{H}
---

```{r include=FALSE}
# this sets the default options for the document 
# these settings turn off warnings, messages and code output
# and also provide default settings for the way charts are displayed
knitr::opts_chunk$set(echo = F, warning = F, message = F, error = F, 
                      fig.width = 6, fig.asp = 0.618, out.width = "70%", 
                      fig.align = "center")

###Loading R packages to be used

library(tidyverse)
library(arsenal)
library(pander)
library(texreg)
library(ggeffects)
library(car)
library(effectsize)
library(broom)
library(MultinomialCI)

###Loading datasets to be used

####Loading survey.csv (for Part 1)

survey <- read_csv(file = "../RM3/survey.csv")
summary(survey)
names(survey)

####Loading rct.csv (for Part 2)

rct <- read_csv(file = "../RM3/rct.csv")
summary(rct)
names(rct)

###Data transformations required

##For Part 1

###Creating factor variables 

survey <- survey %>% 
  mutate(sex_child = factor(sex_child, 
                              levels = c(1,2), 
                              labels = c("Female", "Male")),
         ethnicity_child = factor(ethnicity_child,
         levels=c(1,2,3,4,5),
         labels=c("White",
                  "Mixed or multiple ethnic groups",
                  "Asian or Asian British",
                  "Black, Black British, Caribbean or African",
                  "Other ethnic group")),
        sex_HRP = factor(sex_HRP,
                       levels = c(1,2),
                       labels = c("Female","Male")),
        parent_smoke=factor(parent_smoke,
                            levels=c(0,1),
                            labels=c("No smokers","Smoking parent")),
        housing_damp=factor(housing_damp,
                            levels = c(0,1),
                            labels=c("No damp","Damp housing")))

###For Part 2

###Creating factor variables

rct <- rct %>% 
  mutate(treatment=factor(treatment,
                          levels=c(0,1),
                          labels=c("Control group", "Treatment group")),
                          sex_child = factor(sex_child, 
                            levels = c(1,2), 
                            labels = c("Female", "Male")),
         ethnicity_child = factor(ethnicity_child,
                                  levels=c(1,2,3,4,5),
                                  labels=c("White",
                                           "Mixed or multiple ethnic groups",
                                           "Asian or Asian British",
                                           "Black, Black British, Caribbean or African",
                                           "Other ethnic group")),
         sex_HRP = factor(sex_HRP,
                          levels = c(1,2),
                          labels = c("Female","Male")),
         parent_smoke=factor(parent_smoke,
                             levels=c(0,1),
                             labels=c("No smokers","Smoking parent")),
         housing_damp=factor(housing_damp,
                             levels = c(0,1),
                             labels=c("No damp","Damp housing")))

```


\newpage

# Part 1

## Introduction

We explore whether an association exists between household income and child development outcomes. We try to understand to what extent this relationship could reflect any level of causality and whether other variables could act as mediators. It has been tested in recent literature and overall results have proven to be positive. 

## Methods

### Data

The dataset represents a random sample survey of 2-year-old children in the United Kingdom.It counts on demographic, and household characteristics, as well as the measure of child development scores (CDS onwards). 

### Statistical methods

After a descriptive analysis of the variables, a *Two-sample t test* was run to examine whether development scores were statistically different according to sex of the child. Through linear regression models, we assessed the association between CDS and weekly household income, controlling for demographic,and household variables. Using binary logistic regressions, we evaluated whether weekly household income can help predict children being at or above the expected level of development.

## Results

### Sample characteristics

The proportion of girls is only 0.6 % higher than the proportion of boys, and almost 71% of the children are white. Approximately 86% of the sampled kids do not have smoker parents. In addition, the mean (SD) of weekly household income corresponds to £539.67 (322.95), and only 6.9 % of children live in houses with damp problems.The mean CDS reaches 184.77 (22.38) points.

```{r results='asis'}

# Part 1 

###Creating a descriptive statistics table for variables

Sample_car <- tableby(~ sex_child +ethnicity_child+sex_HRP+
    parent_smoke+income+housing_damp+cd_score, 
  data = survey)

summary(object = Sample_car, 
    text = T, 
        labelTranslations = c(
          sex_child = "Sex of the child", 
          ethnicity_child = "Ethnic group of the child (2021 Census Categories)",
          sex_HRP="Sex of the Household Reference Person",
          parent_smoke="Presence of a smoker parent in the home",
          income="Weekly household income (£)",
          housing_damp="Presence of damp in the home",
          cd_score="Child development score"), 
        digits = 2, 
        title = "Sample Descriptive Statistics")

```

The CDS showed a normal distribution while the distribution of weekly household income is right skewed.It means that most of values are clustered on the left side of the histogram, and few households have an income higher than £1000. 

```{r results='asis'}

###Visualising distributions of variables of interest

####Child development outcomes

ggplot(data=survey)+
  aes(x=cd_score,y=stat(density))+
  geom_histogram(bindwith = 5,col="black",fill="LightBlue",alpha=0.8)+
  labs(title="Chart 1. Distribution of Child Development Outcomes",
       x="Child development score",
       caption="Source:Fictional database by Fransham (2021)")+
  theme(plot.title = element_text(hjust = 0.5))

####Income

ggplot(data=survey)+
  aes(x=income,y=stat(density))+
  geom_histogram(bindwith = 5,col="black",fill="LightBlue",alpha=0.8)+
  labs(title="Chart 2. Distribution of Weekly Household Income (£)",
       x="Income",
       caption="Source:Fictional database by Fransham (2021)")+
  theme(plot.title = element_text(hjust = 0.5))

```

The sample estimate of the CDS was 184.8 (95% CI: `r sprintf("%.2f", t.test(survey$cd_score)$conf.int)`),50.28% for the percentage of girls(95% CI:48.46-52.14), and 49.71% (95% CI:47.88-51.56) for boys. A two sample t test showed that there was a statistically significant difference (t = 13.01, df = 3101.6, p-value <1.067e-37) between boys and girls' mean CDS. As the p-value is very small, we rejected the null hypothesis that there was no difference in the population means of CDS of boys and girls.

```{r include=FALSE}

###Calculating confidence intervals for child development outcomes

summary(survey$cd_score)
t.test(survey$cd_score)$conf.int

###Calculating confidence interval for sex of the child

prop.table(table(survey$sex_child))

multinomialCI(survey$sex_child %>% table(), alpha = 0.05)

```

```{r results='asis'}

###Calculating a two sample t-test for assessing the difference in mean child
###development outcome between male and female children. We chose this test 
###as we want to know whether two sample means of a numeric variable are
###drawn from populations with different means.

t.test(cd_score ~ sex_child, data = survey)%>% 
  tidy() %>% 
  pander(caption = "Two-sample t test of child development score and sex of the child")

```

### Regression models 

The results showed that as the income increases by £1, the CDS increases by 0.015 (95% CI:0.013-0.018) points. As this growth does not seem practically significant, we decided on predicting the child development outcomes for higher household income values. An approximate 200£ increase in income represents an approximate 2-point increase in CDS. We checked the model assumptions and did not find particularly concerning threats.

```{r results='asis'}

###Calculating a simple regression model, where child development score is 
###the dependent variable, and weekly household income, the explanatory variable.

model_1 <- lm(formula = cd_score ~ income, 
              data = survey)

model_1

```

```{r include=FALSE}

###Checking assumptions for Model 1

plot(model_1)

###Calculating confidence intervals for child development outcomes

confint(model_1)

```

```{r results='asis'}

###Predicting new values for Model 1

####Creating a data frame with the values of interest

predict_input <- data.frame(income = seq(300,700,50))

####Creating the predicted values

childdev_predict <- predict(object = model_1, 
                          newdata = predict_input)

####Joining predictions with the input data

predict_final <- 
  bind_cols(child_by_income = childdev_predict, 
            predict_input)

####Plotting predictions

ggplot(data = predict_final) +
  aes(x = income, y = child_by_income) +
  geom_point() +
  geom_line()+
  labs(title="Chart 3. Predicted child development scores, by income (£)",
       x="Income",
       caption="Source:Fictional database by Fransham (2021)")

```

We investigated whether it was possible that a non-linear relationship exists between our two variables of interest. The CDS increases as income increases, but then at approximately £1000 the relationship starts to level off and then gradually decreases.

```{r include=FALSE} 

###Calculating a regression model with a squared term, 
###to estimate whether there is evidence of a non-linear relationship.

non_linear_m1 <- lm(cd_score ~ income + I(income^2), 
         data = survey)

###Creating a table of the linear model and the model with a squared term

knitreg(list(model_1, non_linear_m1), digits = 4)

```

```{r results='asis'}

###Predicting values with the non-linear model

ggpredict(non_linear_m1, terms = "income") %>% 
  plot()

```

Now, controlling for the demographic and household variables, there was a statistically significant association between CDS and income at the p<0.001 level. As income income increases by £1, the CDS increases by 0.014 (95% CI:0.012- 0.017) points.Compared to the first model, there only was a slight difference in the coefficients of income,0.001: in general, the association between the variables keeps its power. We checked the model assumptions and did not find concerning threats. 

Controlling for income, the mean CDS is 10.43 (95% CI:11.895-8.964) points lower for boys compared to girls, the mean CDS is 9.35 (95% CI:11.448-7.268) points lower in children who have smoking parents compared to those who do not, and the mean CDS is 14.74 (95% CI:17.641-11.839) points lower in children who live in homes with a damp compared to those who do not. The remaining variables were not statistically significant.

```{r include=FALSE}

###Calculating a multiple linear regression, where demographic and household
###variables are included as control variables of the relationship 
###between child development outcomes and weekly household income. 

model_2 <- lm(formula = cd_score ~ income+sex_child+ethnicity_child+sex_HRP
              +parent_smoke+housing_damp, 
              data = survey)

model_2

```

```{r include=FALSE}

###Checking assumptions for Model 2

plot(model_2)
vif(model_2)

###Calculating confidence intervals for Model 2

confint(model_2)

```

```{r results='asis'}

###Comparing Model 1 and Model 2

knitreg(list(model_1, model_2), 
        caption = "Linear regression models of child development scores", 
        custom.coef.names = c("(Intercept)", "Weekly income (£)", 
                              "Male", 
                              "Mixed or multiple ethnic groups",
                              "Asian or Asian British",
                              "Black, Black British, Caribbean or African",
                              "Other ethnic group",
                              "Male respondent",
                              "Smoking parent",
                              "Damp housing"), 
        groups = list("Sex of the child (ref. category: Female)" = c(3),
                      "Ethnicity of the child (ref.category: White)"=c(4,5,6,7),
                      "Sex of the Household Reference Person(ref. category: Female)"=c(8),
                      "Presence of a smoker parent (ref. category: No smoking)"=c(9),
                      "Evidence of damp in the home (ref. category: No Damp)"=10),
        digits=4)

```

### Prediction of levels of child development outcomes

To analyse the probability of being at or above the expected level of development (LoD onwards), we established a threshold of 160 points as the minimum required score. Of the sampled children (n=3142),85.9% (2685) of them performed at or above the expected LoD, 14.1% (441) below the LoD and there were 16 missing values. 

```{r results='asis'}

###Creating an indicator of child's expected level of development

survey <- survey %>% 
  mutate(exp_dev_level=ifelse(cd_score>=160,yes = 1, no=0))

###Transforming child's expected level of development into a factor variable

survey <- survey %>% 
  mutate(exp_dev_level = factor(exp_dev_level, 
                            levels = c(0,1), 
                            labels = c("Below expected level", 
                                       "At or above expected level")))

```

```{r include=FALSE}

###Creating a table to check proportions of child's  expected level of development 

Expected_dev_table <- tableby(formula = ~exp_dev_level, data = survey)

summary(object = Expected_dev_table,
        text = T, 
        labelTranslations = c(exp_dev_level = "Level of development"), 
        digits = 2, 
        title = "Expected level of child development scores")

```

Initially, a £1 increase in weekly household income was associated with an odds ratio of 1.001 for being at or above the expected LoD.Controlling for the demographic and household characteristics, as the income increases by £1, the odds ratio of being at or above the expected LoD increases by 1.001 (95% CI:1.001-1.002). Compared to the first model, the coefficient remained the same: in general, the association between being at or above the expected LoD and weekly household income keeps its power.

Controlling for income, the odds ratio of being at or above the expected LoD decreases by 0.387 (95% CI:0.304-0.475) for boys compared to girls, the odds ratio of being at or above the expected LoD decreases by 0.442 (95% CI:0.340-0.576) in children who have smoking parents compared to those who do not, and the odds ratio of being at or above the expected LoD decreases by 0.342 in children who live in homes with a damp compared to those who do not (95% CI:0.248-0.475). The remaining variables were not statistically significant.

```{r include=FALSE}

###Calculating a simple logistic regression.
###Only weekly household income acts as explanatory variable.

model_3 <- glm(exp_dev_level ~ income, 
          family = binomial(link = "logit" ), 
          data = survey)

###Converting to odds ratio

exp(coef(model_3))

###Calculating a new logistic regression model.
###Weekly household income is controlled for demographic and household variables.

model_4 <- glm(exp_dev_level~income+
                 sex_child+
                 ethnicity_child+
                 sex_HRP+
                 parent_smoke+
                 housing_damp, 
          family = binomial(link = "logit"), 
          data = survey)

###Converting to odds ratio

exp(coef(model_4))

```

```{r include=FALSE}

###Calculating confidence intervals for Model 3

exp(confint(model_3))

###Calculating confidence intervals for Model 4

exp(confint(model_4))

```

```{r results='asis'}

###Reporting results of both models

knitreg(list(model_3, model_4), 
        override.coef = list(exp(coef(model_3) ), 
                             exp(coef(model_4) ) ), 
        override.se = list(summary(model_3)$coefficients[, "z value"], 
                           summary(model_4)$coefficients[, "z value"]),
        caption = "Odds ratios for logistic regression models 
        of expected levels of child development", 
        custom.coef.names = c("(Intercept)", "Weekly income (£)", 
                              "Male", 
                              "Mixed or multiple ethnic groups",
                              "Asian or Asian British",
                              "Black, Black British, Caribbean or African",
                              "Other ethnic group",
                              "Male respondent",
                              "Smoking parent",
                              "Damp housing"), 
        groups = list("Sex of the child (ref. category: Female)" = c(3),
                      "Ethnicity of the child(ref.category: White)"=c(4,5,6,7),
                      "Sex of the Household Reference Person(ref.category:Female)"=c(8),
                      "Presence of a smoker parent (ref. category: No smoking)"=c(9),
                      "Evidence of damp in the home (ref. category: no damp)"=10),
        custom.note = "%stars. z-values in brackets", 
        digits = 4)

```

Finally,we show how the probability of being at or above the expected LoD, based on weekly household income, is higher for children with no smoker parents.  

```{r results='asis'}

###Predicting being at or above the expected level of development 
###considering the presence of smoking parents.

m4_predict <- ggpredict(model = model_4, 
                        terms = c("income [0:400]","parent_smoke"))

plot(m4_predict) + ylim(0,1) 

```

## Discussion

There was an association between CDs and weekly household income. Controlling for demographic and household variables, this relationship kept its power. With respect to the association between being at or above the expected LoD and weekly household income, there also was a statistically significant result that remained the same even when controlling for the demographic and household variables. Thus, we could say that the relationship between our variables of interest was strong. However,as more than 80% of children were at or above the expected LoD, results could be highly biased due to this condition. 

\newpage

# Part 2

## Introduction

In this part, we explore whether an increase in child benefit payments had an effect on child development outcomes. We try to understand to what extent an increase in child payments allowed an increase in child development scores, based upon a randomised control trial. There have been studies developed with similar objectives and conditions, with overall positive results. 

## Methods

### Data

We used a fictional dataset designed to represent a randomised controlled trial in which households with low income that had 2-years-old children were randomly assigned to receive an increase in their child benefit payments. The intervention lasted for six months between the times when children were two and two and a half years old. The control group did not receive additional allowances.

### Measures

*Dependent variable*: The post-intervention child development score (PICDS)  was evaluated in five different domains, each rated from 0 to 60. The final result is an aggregation of the five streams, with a minimum score of 0 and a maximum of 300.

*Explanatory variables*: The baseline child development score was evaluated in the same way that PICDS.Demographic characteristics of children included sex and ethnicity. Household characteristics included sex of the Household Reference Person, whether at least one of parents smoked cigarettes, weekly household income, and whether there was evidence of damp in the home.

### Statistical methods

First, a descriptive analysis was carried out to explore the sample flow and the characteristics of variables. Then, we used a simple regression model to estimate the effect size of the treatment, receiving additional child payments, on increasing child development outcomes. We also calculated a standardised measure of the effect size. Finally, we present a chart to visualise the differences -if any- between the treatment and control groups.

## Results

### Participant flow

398 children were included in the trial, half of which were assigned to the treatment group, and the other half to the control group. During the post-intervention measurement, three participants dropped out of the control group, and seven dropped out of the treatment group. The mean child development score before the intervention was 177.72 (23.16) in the control group, and 180.53 (22.39) in the treatment group. The post-intervention mean child development score was 183.80(23.14) in the control group, and 195.98(22.63) in the treatment group.

```{r results='asis'}

# Part 2

## Describing participants flow

###Describing baseline and post-intervention outcomes

Sample_characteristics <- tableby(
  formula = treatment ~ cd_score1+ cd_score2, 
  data = rct)

summary(object = Sample_characteristics,
        text = T, 
        labelTranslations = c(
          cd_score1="Child development score, before the intervention",
          cd_score2="Child development score, after the intervention"), 
        digits = 2, 
        test=F,
        total=F,
        title = "Baseline and Intervention flow, by intervention condition")

```

### Sample characteristics

The table summarizes the sample characteristics considering all variables.The proportion of girls and boys looks slightly different, with more girls in the control group compared to the treatment group. It also can be seen that the treatment group included more children with an Asian or Asian British background compared to the control group, and the control group almost doubled the figures of Black, Black British, Caribbean or African children compared to the treatment group. Most children were White both in the control and treatment group. Concerning the household characteristics, no smokers and smoking parents were equally distributed in the control and treatment group, and the treatment group had an average weekly household income £5 higher compared to the control group. Finally, there were less houses with a damp in the treatment group compared to the control group. 

```{r results='asis'}

###Creating a descriptive statistics table for variables

Sample_characteristics <- tableby(
  formula = treatment ~ sex_child +ethnicity_child+sex_HRP+
    parent_smoke+income+housing_damp, 
  data = rct)

summary(object = Sample_characteristics,
        text = T, 
        labelTranslations = c(
          sex_child = "Sex of the child", 
          ethnicity_child = "Ethnic group of the child (2021 Census Categories)",
          sex_HRP="Sex of the Household Reference Person",
          parent_smoke="Presence of a smoker parent in the home",
          income="Weekly household income (£)",
          housing_damp="Presence of damp in the home"), 
        digits = 2, 
        test=F,
        total=F,
        title = "Sample Descriptive Statistics, by intervention condition")

```

### Regression-based estimate of the effect size 

To assess the effect of the child payments increase on child development scores, we performed a simple linear regression accounting for baseline differences. The treatment was statistically significant at the p<0.001 level, and had an effect of 9.22 (95% CI:8.75-9.70) increase on child development score points.We checked the model assumptions and did not find particularly concerning threats. 

```{r include=FALSE}

###Creating a regression model to estimate the effect size. 
###Post-intervention score is the dependent variable, 
###and baseline score and treatment act as explanatory variables.

model_5 <- lm(cd_score2 ~ cd_score1 + treatment, data = rct) 

###Checking assumptions of the model

plot(model_5)
vif(model_5)

###Calculating confidence intervals

confint(model_5)

###Creating a second linear model, scaling the outcome variable

model_6 <- lm(scale(cd_score2) ~ cd_score1 + treatment, data = rct) 

###Calculating confidence intervals for the new model 

confint(model_6)

```

We then estimated a standardised coefficient by scaling the outcome variables to z scores. The estimate of the treatment effect was 0.40 (95% CI: 0.370- 0.410) standard deviations of the child development score points.

```{r results='asis'}

###Reporting Model 5 and Model 6

knitreg(list(model_5, model_6),
        caption = "Regression-based estimate of treatment 
        effect in child development scores (Original and Standardised coefficients)", 
        custom.coef.names = c("(Intercept)",            
                            "Baseline child development score",
                              "Treatment"),
        digits=3)

```

To make sense of these results, we calculated Cohen’s *d*. We observed that it was very similar in size to the standardised regression coefficient for the treatment effect we estimated earlier.Considering the Cohen's guidelines about effect sizes, we can say that we observed an almost medium effect size, as it was 0.40 (95% CI: 0.38-0.42).

```{r include=FALSE}

###Calculating pooled standard deviation

cd_score2_sdp <- sd_pooled(cd_score2 ~ treatment, 
                              data = rct)

###Calculating effect size and confidence interval

coef(model_5)[3] / cd_score2_sdp
confint(model_5)[3, ] / cd_score2_sdp

###Checking the difference between pooled sd and total sd

cd_score2_sdp
sd(rct$cd_score2, na.rm = T)

```

Finally, we present a chart that shows the difference in means between the post-intervention child development score of the treatment, and the control group.The effect can also be seen through their distributions. It confirms our earlier result of finding a medium effect of increasing child payments on child development outcomes. 

```{r results='asis'}

###Visualising the effect size of the treatment 

ggplot(rct) +
  aes(x = (cd_score2 - cd_score1), y = treatment)+
  geom_point(position = position_jitter(height = 0.1) ) +
  stat_summary(fun = "mean", colour = "Green")+
  labs(title="Treatment assignment",
       x="Change in Baseline and Post-intervention child development scores",
       caption="RCT dataset: green dots show mean change in score") +geom_violin(alpha = 0.2, fill = "steelblue")+ theme_minimal()

```

## Discussion

It was possible to demonstrate that increasing child payments had an effect on child development outcomes. We got a Cohen's *d* of 0.40, which represents a medium effect size. Ten children were dropped out of the study, three of the control group and seven of the treatment group. Furthermore, we observed some differences in balance of the sample characteristics, especially concerning the ethnic group. Most students were white, which could bias the results. Apart from the regression-based estimate of the treatment effect, another regression controlling for ethnic group or sex could help assess this relationship. 

\newpage

# Part 3: Code used in this report 

```{r ref.label=knitr::all_labels(), echo=TRUE, eval=FALSE}
```

**R version and packages used**

```{r results = "asis"}
# print R version and packages
sessionInfo()
```